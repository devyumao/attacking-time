define("level/ui/dialog/RankDialog",function(require){function RankDialog(game){Dialog.call(this,game,{bodyName:"dialog-rank",y:34,ctnX:115,ctnY:246}),this.init()}var global=require("common/global"),color=require("common/color"),util=require("common/util"),Dialog=require("common/ui/Dialog"),Easing=require("common/Easing");return util.inherits(RankDialog,Dialog),RankDialog.prototype.initContent=function(){var me=this;require("common/ajax").get({url:require("common/url").GET_RANK,success:function(res){res=JSON.parse(res),me.preprocessData(res)}}),this.initDoll()},RankDialog.prototype.preprocessData=function(data){var list,me=data.me;me.rank>5?(list=data.list.slice(0,4),me.highest=global.getHighest(),list.push(me)):list=data.list.slice(0,5),this.initRows(list,me.nickname)},RankDialog.prototype.initRows=function(rankData,myNickname){var game=this.game,container=this.container;rankData.forEach(function(data,index){var row=game.add.image(0,25+58*index,"transparent-2");row.anchor.set(0,.5),container.addChild(row);var rankText=game.add.text(8,0,data.rank?data.rank>999?"999+":data.rank:index+1,{font:"bold 22px "+global.fontFamily,fill:color.get("dark-purple")});rankText.anchor.set(0,.5),data.rank&&data.rank>999&&rankText.scale.set(45/rankText.width),row.addChild(rankText);var nameText=game.add.text(55,0,data.nickname.replace(/-/g,""),{font:"20px "+global.fontFamily,fill:color.get("dark-purple")});if(nameText.anchor.set(0,.5),row.addChild(nameText),data.nickname===myNickname){var meTip=game.add.image(nameText.x+nameText.width+4,-2,"me-tip");meTip.anchor.set(0,.5),row.addChild(meTip);var meText=game.add.text(meTip.width-4,1,"me",{font:"bold 16px "+global.fontFamily,fill:color.get("white")});meText.anchor.set(1,.5),meTip.addChild(meText)}var scoreText=game.add.text(251,0,data.highest+"",{font:"bold 22px "+global.fontFamily,fill:color.get("cherry")});scoreText.anchor.set(1,.5),row.addChild(scoreText)})},RankDialog.prototype.initDoll=function(){var game=this.game,container=this.container,doll=game.add.image(300,377,"dialog-rank-doll");doll.anchor.set(.5,1),doll.angle+=4,container.addChild(doll),game.add.tween(doll).to({angle:"-8"},1e3,Easing.Sinusoidal.InOut,!0,0,-1,!0)},RankDialog}),define("level/ui/popup/RolePopup",function(require){function RolePopup(game,options){options||(options={}),Popup.call(this,game,{hasHeader:!0,headerType:"icon",headerIcon:"icon-hero",title:"选择角色",y:50,height:652,hasMaskTouch:options.hasMaskTouch}),this.init()}var global=require("common/global"),color=require("common/color"),util=require("common/util"),Popup=require("common/ui/Popup");return util.inherits(RolePopup,Popup),RolePopup.prototype.initContent=function(){var me=this,game=this.game,container=this.container,level=game.state.states.level,audioClick=level.audioClick;global.herosConfig.forEach(function(heroConfig,index){var panelEdgeHeight=game.cache.getImage("panel-edge-yellow").height,panelHeight=150+2*panelEdgeHeight,panelCtn=game.add.button((me.containerWidth+190*(index%2?1:-1))/2,(20+panelHeight)*Math.floor(index/2)+20,"transparent-2",function(){audioClick.play(),this.select(heroConfig.id),this.hide()},me);container.addChild(panelCtn),util.addHover(panelCtn);var panelTopEdge=game.add.image(0,0,"panel-edge-"+heroConfig.color);panelTopEdge.anchor.set(.5,0),panelCtn.addChild(panelTopEdge);var panelMain=game.add.image(panelTopEdge.x,panelTopEdge.y+panelEdgeHeight,"pixel-"+heroConfig.color);panelMain.scale.set(85,75),panelMain.anchor.set(.5,0),panelCtn.addChild(panelMain);var panelBottomEdge=game.add.image(panelTopEdge.x,panelMain.y+150+panelEdgeHeight,"panel-edge-"+heroConfig.color);panelBottomEdge.scale.y=-1,panelBottomEdge.anchor.set(.5,0),panelCtn.addChild(panelBottomEdge);var legend=game.add.image(0,70,"legend-"+heroConfig.name);legend.anchor.set(.5),legend.scale.set(.92),panelCtn.addChild(legend);var nameText=game.add.text(0,130,heroConfig.chName,{font:"bold 24px "+global.fontFamily,fill:color.get("dark-purple")});nameText.anchor.set(.5,0),panelCtn.addChild(nameText)})},RolePopup.prototype.select=function(id){var game=this.game;if(game.state.states.level.hero.change(id),!global.getNickname()){var heroConfig=global.herosConfig[global.getSelected()];global.setNickname(global.getRandomNameTitle()+heroConfig.chName),game.state.states.level.title.tween()}},RolePopup}),define("level/ui/Title",function(require){function Title(game){this.game=game,this.body=null,this.tweenChain=null,this.init()}var Easing=require("common/Easing");return Title.prototype.init=function(){var game=this.game,body=game.add.image(game.width/2,64,"transparent-2");body.anchor.set(.5,0),this.body=body;var fly=game.add.image(-294,282,"title-fly");fly.anchor.set(.5),body.addChild(fly);var titleXd=game.add.image(-96,117,"title-xd");titleXd.anchor.set(.5),body.addChild(titleXd);var hero=game.add.image(76,92,"title-hero");hero.anchor.set(.5),hero.scale.set(0),body.addChild(hero);var titleXqc=game.add.image(56,161,"title-xqc");titleXqc.anchor.set(.5),body.addChild(titleXqc);var flyMove=game.add.tween(fly).to({x:"170",y:"-84"},450,Easing.Quadratic.Out,!1,500),heroLargen=game.add.tween(hero.scale).to({x:1,y:1},400,Easing.Quadratic.InOut),xqcShake=game.add.tween(titleXqc).to({angle:"-5"},150,Easing.Quadratic.InOut,!1,0,2,!0);flyMove.chain(heroLargen),heroLargen.chain(xqcShake),flyMove.onStart.add(function(){setTimeout(function(){game.add.audio("fly").play()},500)}),heroLargen.onStart.add(function(){game.add.audio("hero-fly").play()}),this.tweenChain=flyMove},Title.prototype.tween=function(){this.tweenChain.start()},Title.prototype.fadeOut=function(){var game=this.game,body=this.body,move=game.add.tween(body).to({y:-240},200,Easing.Quadratic.In);move.onComplete.add(function(){body.destroy()},this),move.start()},Title}),define("level/ui/Tip",function(require){function Tip(game,options){this.game=game,this.text=options.text,this.textText=null,this.init()}var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing");return Tip.prototype.init=function(){var game=this.game,textText=game.add.text(game.width/2,135,this.text,{font:"bold 26px "+global.fontFamily,fill:color.get("white"),align:"center"});textText.anchor.set(.5,0),this.textText=textText,this.show()},Tip.prototype.show=function(){this.game.add.tween(this.textText).from({alpha:0},300,Easing.Quadratic.Out,!0)},Tip.prototype.hide=function(){var hide=this.game.add.tween(this.textText).to({alpha:0},300,Easing.Quadratic.In);hide.onComplete.add(function(){this.destroy()},this),hide.start()},Tip.prototype.destroy=function(){this.textText.destroy()},Tip}),define("level/ui/Start",function(require){function Start(game,options){this.game=game,this.button=null,this.ring=null,this.onClick=options.onClick,this.context=options.context,this.init()}var Easing=require("common/Easing");return Start.prototype.init=function(){var game=this.game,button=game.add.button(game.width/2,458,"start",this.onClick,this.context);button.anchor.set(.5),button.scale.set(.5),this.button=button;var ring=game.add.image(0,0,"start-ring");ring.anchor.set(.5),button.addChild(ring),this.ring=ring,this.shake()},Start.prototype.disable=function(){this.button.inputEnabled=!1},Start.prototype.shake=function(){this.game.add.tween(this.button).to({y:"-15"},2e3,Easing.Sinusoidal.InOut,!0,0,-1,!0)},Start.prototype.fadeOut=function(){var game=this.game,largen=game.add.tween(this.ring.scale).to({x:1.3,y:1.3},750,Easing.Linear.None),hide=game.add.tween(this.button).to({alpha:0},750,Easing.Linear.None);hide.onComplete.add(function(){this.destroy()},this),hide.start(),largen.start()},Start.prototype.destroy=function(){this.button.destroy()},Start}),define("level/ui/Scoreboard",function(require){function Scoreboard(game){this.game=game,this.score=0,this.text=null,this.board=null,this.init()}var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing");return Scoreboard.prototype.init=function(){var game=this.game,board=game.add.image(game.width/2,85,"scoreboard");board.anchor.set(.5),this.board=board;var text=game.add.text(0,2,this.score+"",{font:"bold 48px "+global.fontFamily,fill:color.get("white")});text.anchor.set(.5),board.addChild(text),this.text=text},Scoreboard.prototype.getScore=function(){return this.score},Scoreboard.prototype.addScore=function(value){this.score+=value;var text=this.text;text.text=this.score+"";var game=this.game,easingQuadratic=Easing.Quadratic,largen=game.add.tween(text.scale).to({x:1.2,y:1.2},200,easingQuadratic.Out),recover=game.add.tween(text.scale).to({x:1,y:1},200,easingQuadratic.In);largen.chain(recover),largen.start()},Scoreboard}),define("level/ui/Praise",function(require){function Praise(game,options){this.game=game,this.pointsText=null,this.praiseText=null,this.points=options.points,this.pointsX=options.pointsX,this.init()}var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing"),config=require("level/config");return Praise.prototype.init=function(){var game=this.game,pointsText=game.add.text(this.pointsX,game.height-config.HORIZON,"+"+this.points,{font:"bold 24px "+global.fontFamily,fill:color.get("yellow")});pointsText.anchor.set(.5,1),pointsText.alpha=0,this.pointsText=pointsText;var sentences=["赞 哟 !","好 棒 !","└(^o^)┘"],praiseText=game.add.text(game.width/2,230,sentences[game.rnd.between(0,sentences.length-1)],{font:"bold 36px "+global.fontFamily,fill:color.get("white")});praiseText.anchor.set(.5,0),praiseText.alpha=0,this.praiseText=praiseText,this.tween()},Praise.prototype.tween=function(){var game=this.game,pointsText=this.pointsText,showPoints=game.add.tween(pointsText).to({alpha:1},350,Easing.Quadratic.Out,!1),hidePoints=game.add.tween(pointsText).to({alpha:0},350,Easing.Quadratic.In,!1),risePoints=game.add.tween(pointsText).to({y:"-20"},700,Easing.Linear.None,!1);risePoints.onComplete.add(function(){pointsText.destroy()}),showPoints.chain(hidePoints),showPoints.start(),risePoints.start();var praiseText=this.praiseText,showPraise=game.add.tween(praiseText).to({alpha:1},400,Easing.Quadratic.Out,!1),hidePraise=game.add.tween(praiseText).to({alpha:0},400,Easing.Quadratic.In,!1,300);hidePraise.onComplete.add(function(){praiseText.destroy()}),showPraise.chain(hidePraise),showPraise.start()},Praise}),define("level/ui/MenuBtns",function(require){function MenuBtns(game){this.game=game,this.group=game.add.group(),this.init()}var global=require("common/global"),color=require("common/color"),util=require("common/util");return MenuBtns.prototype.init=function(){var game=this.game,level=game.state.states.level,audioClick=level.audioClick,btnConfigs=[{position:"right",icon:"icon-hero",title:"角色",onClick:function(){audioClick.play(),new(require("./popup/RolePopup"))(game)}},{position:"left",icon:"icon-podium",title:"排名",onClick:function(){audioClick.play(),new(require("./dialog/RankDialog"))(game)}}],btnWidth=game.cache.getImage("menu-btn").width,bottom=160+btnWidth/2,posConfig={};posConfig.left={index:0,x:30+btnWidth/2,titleX:btnWidth/2+8,titleAnchorX:0},posConfig.right={index:0,x:game.width-posConfig.left.x,titleX:-btnWidth/2-8,titleAnchorX:1};var group=this.group;btnConfigs.forEach(function(config){var pos=config.position,btn=game.add.button(posConfig[pos].x,game.height-bottom-70*posConfig[pos].index,"menu-btn",config.onClick);btn.anchor.set(.5),util.addHover(btn),group.add(btn);var icon=game.add.image(0,0,config.icon);icon.anchor.set(.5),icon.width=34,icon.height=icon.width,btn.addChild(icon);var title=game.add.text(posConfig[pos].titleX,0,config.title,{font:"bold 28px "+global.fontFamily,fill:color.get("white")});title.anchor.set(posConfig[pos].titleAnchorX,.5),title.alpha=.8,title.setShadow(1,1,color.get("black"),4),btn.addChild(title),++posConfig[pos].index})},MenuBtns.prototype.destroy=function(){this.group.destroy()},MenuBtns}),define("level/ui/Foodboard",function(require){function Foodboard(game){this.game=game,this.text=null,this.legend=null,this.init()}var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing");return Foodboard.prototype.init=function(){var game=this.game,text=game.add.text(game.width-63,20,global.getFoodCount()+"",{font:"bold 30px "+global.fontFamily,fill:color.get("white")});text.anchor.set(1,.5),text.y+=text.height/2,this.text=text;var legend=game.add.image(game.width-20,18,"food");legend.width=35,legend.height=legend.width,legend.anchor.set(1,0),this.legend=legend},Foodboard.prototype.update=function(){var text=this.text;text.text=global.getFoodCount()+"";var game=this.game,easingQuadratic=Easing.Quadratic,largen=game.add.tween(text.scale).to({x:1.2,y:1.2},200,easingQuadratic.Out),recover=game.add.tween(text.scale).to({x:1,y:1},200,easingQuadratic.In);largen.chain(recover),largen.start()},Foodboard}),define("level/ui/End",function(require){function End(game,options){this.game=game,this.mask=null,this.body=null,this.score=options.score,this.hasNewRecord=options.hasNewRecord,this.init()}var global=require("common/global"),color=require("common/color"),util=require("common/util"),Mask=require("common/ui/Mask"),Easing=require("common/Easing");return End.prototype.init=function(){this.initMask(),this.initBody(),this.initBoard(),this.initBtns(),this.initDoll(),this.intCopyright(),this.show(),this.hasNewRecord&&this.showShareMask(),this.updateShare()},End.prototype.initMask=function(){var Mask=require("common/ui/Mask");this.mask=new Mask(this.game,{alpha:.6})},End.prototype.initBody=function(){var game=this.game,body=game.add.image(game.width/2,80);body.anchor.set(.5,0),this.body=body},End.prototype.initBoard=function(){var game=this.game,body=this.body,board=game.add.image(0,90,"end-board");board.anchor.set(.5,0),body.addChild(board);var valueFontStyle={font:"bold 48px "+global.fontFamily,fill:color.get("cherry")},scoreValue=game.add.text(64,114,this.score+"",valueFontStyle);scoreValue.anchor.set(1,0),board.addChild(scoreValue);var hightest=global.getHighest(),highestValue=game.add.text(64,190,hightest+"",valueFontStyle);if(highestValue.anchor.set(1,0),board.addChild(highestValue),this.hasNewRecord){var newRecord=game.add.image(scoreValue.x+10,scoreValue.y-8,"new-record");board.addChild(newRecord)}},End.prototype.transition=function(){return new Mask(this.game,{alpha:1}).show(150)},End.prototype.initBtns=function(){var me=this,game=this.game,body=this.body,STATUS=global.LEVEL_STATUS,level=game.state.states.level,audioClick=level.audioClick;[{texture:"btn-share",text:"炫耀一下",onClick:function(){audioClick.play(),me.showShareMask()}},{texture:"btn-home",text:"返回菜单",onClick:function(){audioClick.play(),me.transition().then(function(){game.state.start("level",!0,!1,STATUS.MENU)})}},{texture:"btn-restart",text:"再玩一次",onClick:function(){audioClick.play(),me.transition().then(function(){game.state.start("level",!0,!1,STATUS.PLAY)})}}].forEach(function(config,index){var btn=game.add.button(115*(index-1),440,config.texture,config.onClick);btn.anchor.set(.5),util.addHover(btn),body.addChild(btn)})},End.prototype.initDoll=function(){var game=this.game,doll=game.add.image(-575,-460,"end-doll");doll.anchor.set(-1.3,-2.5),doll.angle+=2,this.body.addChild(doll),game.add.tween(doll).to({angle:"-8"},1500,Easing.Sinusoidal.InOut,!0,0,-1,!0)},End.prototype.intCopyright=function(){var game=this.game,copyright=game.add.image(0,600,"copyright");copyright.anchor.set(.5,0),copyright.scale.set(.52),this.body.addChild(copyright)},End.prototype.showShareMask=function(){var game=this.game,mask=new Mask(game,{alpha:.6});mask.show(150);var tipText=game.add.text(game.width/2,200,"点击右上角\n分享到朋友圈",{font:"bold 42px "+global.fontFamily,fill:color.get("white"),align:"center"});tipText.anchor.set(.5,0);var ease=Easing.Quadratic.InOut;game.add.tween(tipText).from({alpha:0},150,ease,!0);var hide=function(){mask.hide(400);var hideTip=game.add.tween(tipText).to({alpha:0},400,ease);hideTip.onComplete.add(function(){tipText.destroy()}),hideTip.start()};mask.bindTouch(hide),setTimeout(hide,1e3)},End.prototype.show=function(){this.mask.show(500),this.game.add.tween(this.body).from({alpha:0},500,Easing.Quadratic.InOut,!0)},End.prototype.updateShare=function(){global.setShareText("我作为开发SSGer冲过了"+this.score+"道难关，你也来试试吧！"),require("common/weixin").updateShare()},End}),define("level/ui/Combo",function(require){function Combo(game){this.game=game,this.count=0,this.body=null,this.countText=null,this.init()}var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing");return Combo.prototype.init=function(){var game=this.game,body=game.add.image(20,168);body.alpha=0,this.body=body;var label=game.add.text(0,0,"COMBO",{font:"bold 36px "+global.fontFamily,fill:color.get("orange"),strokeThickness:8,stroke:color.get("white")});label.anchor.set(0,.5),body.addChild(label);var multipleSign=game.add.text(label.width+5,0,"×",{font:"bold 36px "+global.fontFamily,fill:color.get("white")});multipleSign.anchor.set(0,.5),body.addChild(multipleSign);var countText=game.add.text(multipleSign.x+multipleSign.width+18,0,this.count+"",{font:"bold 36px "+global.fontFamily,fill:color.get("cherry"),strokeThickness:8,stroke:color.get("white")});countText.anchor.set(.5),this.countText=countText,body.addChild(countText)},Combo.prototype.get=function(){return this.count},Combo.prototype.show=function(){this.game.add.tween(this.body).to({alpha:1},300,Easing.Quadratic.Out,!0)},Combo.prototype.hide=function(){this.game.add.tween(this.body).to({alpha:0},300,Easing.Quadratic.In,!0)},Combo.prototype.add=function(){this.count||this.show();var countText=this.countText;countText.text=++this.count+"";var game=this.game,easingQuadratic=Easing.Quadratic,largen=game.add.tween(countText.scale).to({x:1.5,y:1.5},200,easingQuadratic.Out),recover=game.add.tween(countText.scale).to({x:1,y:1},200,easingQuadratic.In);largen.chain(recover),largen.start()},Combo.prototype.reset=function(){this.count&&(this.hide(),this.count=0)},Combo}),define("level/scene/Foreground",function(require){function Foreground(game,options){this.game=game,this.objects=options.objects,this.elements=[],this._init()}var util=require("common/util"),Easing=require("common/Easing");return Foreground.prototype._init=function(){this.update()},Foreground.prototype.update=function(){var elements=[];this.objects.forEach(function(obj){var el=obj.getPhaserObjects();el&&(util.isArray(el)?el.forEach(function(item){item&&elements.push(item)}):elements.push(el))}),this.elements=elements},Foreground.prototype.move=function(offsetX){var game=this.game,elements=this.elements;offsetX+="";var promises=[];return elements.forEach(function(el,index){var move=game.add.tween(el).to({x:offsetX},300,Easing.Linear.None);promises.push(new Promise(function(resolve){move.onComplete.add(resolve)})),move.start()}),Promise.all(promises)},Foreground}),define("level/scene/Fog",function(require){var Fog=function(game){this.game=game,this.image=null,this.init()};return Fog.prototype.init=function(){var game=this.game,image=game.add.image(0,0,"pixel-white");image.scale.set(game.width/image.width,game.height/image.height),image.alpha=0,this.image=image},Fog}),define("level/scene/Building",function(require){var Easing=require("common/Easing"),Building=function(game){this.game=game,this.image=null,this.init()};return Building.prototype.init=function(){var game=this.game,image=game.add.image(220,620,"building");image.anchor.set(.5,0),this.image=image},Building.prototype.fadeOut=function(){var game=this.game,image=this.image,move=game.add.tween(image).to({y:game.height},200,Easing.Linear.None);move.onComplete.add(function(){image.destroy()},this),move.start()},Building}),define("level/scene/Background",function(require){function Background(game,options){this.game=game,this.image=null,this.imagePrefix=options.imagePrefix,this.index=options.index,this.speed=options.speed?options.speed:0,this.init()}var config=require("level/config");return Background.prototype.init=function(){var game=this.game,imageName=this.imagePrefix,image=game.add.tileSprite(0,0,game.cache.getImage(imageName).width,game.height,imageName);this.image=image,image.tilePosition.x-=config.THEME[this.index].OFFSET},Background.prototype.scroll=function(){this.image.tilePosition.x-=this.speed},Background}),define("common/ui/Popup",function(require){function Popup(game,options){options||(options={}),this.game=game,this.mask=null,this.body=null,this.header=null,this.container=null,this.main=null,this.topEdge=null,this.bottomEdge=null,this.elements=[],this.hasHeader=!!options.hasHeader,this.headerType=options.headerType?options.headerType:"",this.headerIcon=options.headerIcon?options.headerIcon:"",this.width=game.cache.getImage("popup-edge").width,this.height=options.height?options.height:520,this.y=options.y?options.y:120,this.paddingHorz=12,this.paddingTop=30,this.paddingBottom=options.paddingBottom?options.paddingBottom:30,this.containerWidth=this.width-2*this.paddingHorz,this.containerHeight=0,this.title=options.title?options.title:"",this.hasMaskTouch=void 0===options.hasMaskTouch||options.hasMaskTouch}var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing");return Popup.prototype.init=function(){this.initMask(),this.initBody(),this.hasHeader&&this.initHeader(),this.initContainer(),this.initContent(),this.show()},Popup.prototype.initMask=function(){var me=this,Mask=require("common/ui/Mask");this.mask=new Mask(this.game,{alpha:.4,onTouch:this.hasMaskTouch?function(){me.mask.unbindTouch(),me.hide()}:null})},Popup.prototype.initBody=function(){var game=this.game,body=game.add.image(game.width/2,game.height);body.anchor.set(.5,0),body.inputEnabled=!0,this.body=body,this.elements.push(body);var topEdge=game.add.image(0,0,"popup-edge");topEdge.anchor.set(.5,0),body.addChild(topEdge),this.topEdge=topEdge;var edgeHeight=topEdge.height,main=game.add.image(0,edgeHeight,"pixel-white");main.scale.set(this.width/2,(this.height-2*edgeHeight)/2),main.anchor.set(.5,0),main.alpha=.7,body.addChild(main),this.main=main;var bottomEdge=game.add.image(0,2*edgeHeight+main.height,"popup-edge");bottomEdge.scale.y=-1,bottomEdge.anchor.set(.5,0),body.addChild(bottomEdge),this.bottomEdge=bottomEdge},Popup.prototype.initHeader=function(){var game=this.game,header=game.add.image(-this.width/2,game.cache.getImage("popup-header").height/2,"popup-header");header.anchor.set(0,.5),this.body.addChild(header),this.header=header;var titleText=game.add.text(12,3,this.title,{font:"bold 30px "+global.fontFamily,fill:color.get("white")});switch(titleText.anchor.set(0,.5),header.addChild(titleText),this.headerType){case"icon":var icon=game.add.image(this.width-12,0,this.headerIcon);icon.width=35,icon.height=icon.width,icon.anchor.set(1,.5),header.addChild(icon);break;case"food":var food=game.add.image(this.width-12,0,"food");food.width=30,food.height=food.width,food.anchor.set(1,.5),header.addChild(food);var foodCountText=game.add.text(food.x-food.width-10,3,global.getFoodCount()+"",{font:"bold 24px "+global.fontFamily,fill:color.get("dark-grey")});foodCountText.anchor.set(1,.5),header.addChild(foodCountText)}},Popup.prototype.initContainer=function(){var game=this.game,margin=this.paddingHorz;this.hasHeader&&(this.paddingTop=this.header.height);var container=game.add.image((game.width-this.width)/2+margin,game.height+this.paddingTop);this.containerHeight=this.height-this.paddingTop-this.paddingBottom,this.container=container,this.elements.push(container),this.initCrop()},Popup.prototype.initCrop=function(){var game=this.game,margin=this.paddingHorz,container=this.container,crop=this.game.add.graphics(0,0);crop.beginFill(16777215),crop.drawRect(container.x,game.height+this.paddingTop,this.width-2*margin,this.containerHeight),crop.endFill(),container.mask=crop,this.elements.push(crop)},Popup.prototype.initContent=function(){},Popup.prototype.setHeight=function(height){var originHeight=this.height;this.height=height;var heightDiff=height-originHeight;this.main.height+=heightDiff,this.bottomEdge.y+=heightDiff,this.container.mask.destroy(),this.containerHeight+=heightDiff,this.initCrop()},Popup.prototype.show=function(){this.mask.show(500);var game=this.game,y=this.y;this.elements.forEach(function(el){game.add.tween(el).to({y:y-game.height+""},600,Easing.Back.Out,!0)})},Popup.prototype.hide=function(tweenEnabled){this.mask.hide(500);var game=this.game,y=this.y;void 0===tweenEnabled&&(tweenEnabled=!0),tweenEnabled?this.elements.forEach(function(el){var move=game.add.tween(el).to({y:game.height-y+""},600,Easing.Back.In);move.onComplete.add(function(){el.destroy()}),move.start()}):this.elements.forEach(function(el){el.destroy()})},Popup}),define("common/ui/Mask",function(require){function Mask(game,options){this.game=game,this.image=null,this.alpha=options.alpha?options.alpha:1,this.onTouch=options.onTouch?options.onTouch:null,this.init()}var Easing=require("common/Easing");return Mask.prototype.init=function(){var game=this.game,image=game.add.image(0,0,"pixel-black");image.scale.set(game.width/image.width,game.height/image.height),image.alpha=this.alpha,image.inputEnabled=!0,this.image=image,this.onTouch&&this.bindTouch(this.onTouch)},Mask.prototype.show=function(duration){if(duration){var show=this.game.add.tween(this.image).from({alpha:0},duration,Easing.Quadratic.InOut),promise=new Promise(function(resolve){show.onComplete.add(resolve)});return show.start(),promise}return Promise.resolve()},Mask.prototype.hide=function(duration){if(duration){var hide=this.game.add.tween(this.image).to({alpha:0},duration,Easing.Quadratic.InOut),me=this,promise=new Promise(function(resolve){hide.onComplete.add(function(){this.destroy(),resolve()},me)});return hide.start(),promise}return this.image.alpha=0,this.destroy(),Promise.resolve()},Mask.prototype.bindTouch=function(onTouch){this.image.events.onInputUp.add(onTouch)},Mask.prototype.unbindTouch=function(){this.image.events.onInputUp.removeAll()},Mask.prototype.destroy=function(){this.image.destroy()},Mask}),define("common/ui/Dialog",function(require){function Dialog(game,options){this.game=game,this.mask=null,this.bodyName=options.bodyName,this.body=null,this.y=options.y?options.y:40,this.ctnX=options.ctnX,this.ctnY=options.ctnY,this.elements=[],this.hasMaskTouch=void 0===options.hasMaskTouch||options.hasMaskTouch}var Easing=require("common/Easing");return Dialog.prototype.init=function(){this.initMask(),this.initBody(),this.initContainer(),this.initContent(),this.show()},Dialog.prototype.initMask=function(){var me=this,Mask=require("common/ui/Mask");this.mask=new Mask(this.game,{alpha:.5,onTouch:this.hasMaskTouch?function(){me.mask.unbindTouch(),me.hide()}:null})},Dialog.prototype.initBody=function(){var game=this.game,body=game.add.image(game.width/2,game.height,this.bodyName);body.anchor.set(.5,0),this.body=body,this.elements.push(body)},Dialog.prototype.initContainer=function(){var game=this.game,container=game.add.image(this.ctnX,game.height+this.ctnY-this.y,"transparent-2");this.container=container,this.elements.push(container)},Dialog.prototype.initContent=function(){},Dialog.prototype.show=function(){this.mask.show(500);var game=this.game,y=this.y;this.elements.forEach(function(el){game.add.tween(el).to({y:y-game.height+""},600,Easing.Back.Out,!0)})},Dialog.prototype.hide=function(tweenEnabled){this.mask.hide(500);var game=this.game,y=this.y;void 0===tweenEnabled&&(tweenEnabled=!0),tweenEnabled?this.elements.forEach(function(el){var move=game.add.tween(el).to({y:game.height-y+""},600,Easing.Back.In);move.onComplete.add(function(){el.destroy()}),move.start()}):this.elements.forEach(function(el){el.destroy()})},Dialog}),define("common/ui/Confirm",function(require){function Confirm(game,options){Popup.call(this,game,{hasHeader:!1,height:280,y:200}),this.text=options.text?options.text:"",this.onConfirm=options.onConfirm,this.init()}var global=require("common/global"),color=require("common/color"),util=require("common/util"),Popup=require("common/ui/Popup");return util.inherits(Confirm,Popup),Confirm.prototype.initContent=function(){this.initText(),this.initBtns()},Confirm.prototype.initText=function(){var game=this.game,container=this.container,textText=game.add.text(this.containerWidth/2,40,this.text,{font:"28px "+global.fontFamily,fill:color.get("coffee"),align:"center"});textText.anchor.set(.5,0),textText.lineSpacing=10,container.addChild(textText)},Confirm.prototype.initBtns=function(){var game=this.game,container=this.container,btnConfirm=game.add.button(this.containerWidth/2+25,this.containerHeight,"btn-confirm",function(){this.onConfirm(),this.hide()},this);btnConfirm.anchor.set(0,1),util.addHover(btnConfirm),container.addChild(btnConfirm);var btnCancel=game.add.button(this.containerWidth/2-25-btnConfirm.width,this.containerHeight,"btn-confirm",function(){this.hide()},this);btnCancel.anchor.set(0,1),util.addHover(btnCancel),container.addChild(btnCancel);var fontStyle={font:"bold 30px "+global.fontFamily,fill:color.get("coffee")},confirmText=game.add.text(btnConfirm.width/2,-btnConfirm.height/2,"是",fontStyle);confirmText.anchor.set(.5),btnConfirm.addChild(confirmText);var cancelText=game.add.text(btnCancel.width/2,-btnCancel.height/2,"否",fontStyle);cancelText.anchor.set(.5),btnCancel.addChild(cancelText)},Confirm}),define("level/level",function(require){function onInputDown(){var hero=this.hero;this.isHoldEnabled&&(this.isBeingHeld=!0,this.audioStickLengthen.play()),this.isTouchEnabled&&hero.flip()}function onInputUp(){this.isHoldEnabled&&this.isBeingHeld&&(this.audioStickLengthen.stop(),this.isBeingHeld=!1,this.isHoldEnabled=!1,this.layDownStick())}var global=require("common/global"),config=require("level/config"),Background=require("./scene/Background"),Foreground=require("./scene/Foreground"),Fog=require("./scene/Fog"),Building=require("./scene/Building"),Start=require("./ui/Start"),MenuBtns=require("./ui/MenuBtns"),Title=require("./ui/Title"),End=require("./ui/End"),Stage=require("./Stage"),Hero=require("./Hero"),Stick=require("./Stick"),Scoreboard=require("./ui/Scoreboard"),Tip=require("./ui/Tip"),Praise=require("./ui/Praise"),Combo=require("./ui/Combo"),STATUS=global.LEVEL_STATUS,level={};return level.init=function(status){this.status=status},level.create=function(){var game=this.game;switch(this.reset(),this.initAudios(),this.status){case STATUS.MENU:this.initMenuStatus();break;case STATUS.PLAY:this.initPlayStatus()}if(this.transition(),!global.getNickname()){new(require("./ui/popup/RolePopup"))(game,{hasMaskTouch:!1})}},level.update=function(){if(this.background.scroll(),this.status===STATUS.PLAY){this.shouldMgScroll&&(this.nearMidground.scroll(),this.farMidground.scroll()),this.isHoldEnabled&&this.isBeingHeld&&this.stick.lengthen();var food=this.stage.getFood();food&&food.isStartingBeingEaten(this.hero)&&(this.audioTool.play(),this.scoreboard.addScore(2))}},level.reset=function(){this.isHoldEnabled=!1,this.isBeingHeld=!1,this.isTouchEnabled=!1,this.shouldMgScroll=!1,this.theme=1,global.resetShareText(),require("common/weixin").updateShare()},level.initAudios=function(){var game=this.game;this.audioGround=game.add.audio("ground"),this.audioClick=game.add.audio("click"),this.audioStickLayDown=game.add.audio("stick-lay-down"),this.audioPass=game.add.audio("pass"),this.audioTool=game.add.audio("tool"),this.audioSpot=game.add.audio("spot"),this.audioStickLengthen=game.add.audio("stick-lengthen"),this.audioWall=game.add.audio("wall")},level.transition=function(){new(require("common/ui/Mask"))(this.game,{alpha:1}).hide(150)},level.initView=function(){var game=this.game;this.background=new Background(game,{index:this.theme,imagePrefix:"bg",speed:.3}),this.farMidground=new Background(game,{index:this.theme,imagePrefix:"mg-far",speed:1}),this.nearMidground=new Background(game,{index:this.theme,imagePrefix:"mg-near",speed:2}),this.fog=new Fog(game)},level.initBaseObjs=function(){this.initView();var game=this.game;this.stage=new Stage(game,{index:this.theme}),
this.hero=new Hero(game,{index:global.getSelected()})},level.initMenuStatus=function(){this.initBaseObjs();var game=this.game;this.start=new Start(game,{onClick:function(){this.start.disable(),this.start.fadeOut(),this.audioClick.play(),this.initPlayStatus()},context:this}),this.building=new Building(game),this.menuBtns=new MenuBtns(game),this.title=new Title(game),global.getNickname()&&this.title.tween()},level.initPlayStatus=function(){var game=this.game;switch(this.status){case STATUS.PLAY:this.initBaseObjs(),[this.hero,this.stage].forEach(function(item){item.enablePlay(!1)}),this.isHoldEnabled=!0;break;case STATUS.MENU:this.building.fadeOut(),this.title.fadeOut(),[this.menuBtns].forEach(function(item){item.destroy()});var promises=[];[this.hero,this.stage].forEach(function(item){promises.push(item.enablePlay(!0))});var me=this;Promise.all(promises).then(function(){me.status=STATUS.PLAY,me.isHoldEnabled=!0})}this.scoreboard=new Scoreboard(game),this.stick=new Stick(game),this.foreground=new Foreground(game,{objects:[this.stage,this.hero,this.stick]}),global.getHighest()<2&&(this.playTip=new Tip(game,{text:config.TIP.PLAY})),this.combo=new Combo(game),this.bindTouch()},level.bindTouch=function(){var game=this.game;game.input.onDown.add(onInputDown,this),game.input.onUp.add(onInputUp,this)},level.layDownStick=function(){var stick=this.stick,me=this;this.stick.layDown().then(function(){me.isTouchEnabled=!0;var stage=me.stage;if(stick.getFullLength()>stage.getInterval()){me.audioStickLayDown.play();var combo=me.combo;if(stick.isInSpot(stage)){me.audioSpot.play(),combo.add();var points=stage.getSpotMultiple()*combo.get();me.scoreboard.addScore(points),new Praise(me.game,{points:points,pointsX:stage.getSpotX()})}else combo.reset();return me.makeHeroWalkToNext()}return me.makeHeroWalkToStickEnd()}).then(function(result){result.isFailed&&me.fail()})},level.makeHeroWalkToNext=function(){var me=this,hero=this.hero,stage=this.stage;return hero.walk(stage.getCurrEdgeX()+stage.getInterval()).then(function(){return me.isTouchEnabled=!1,hero.isUpsideDown()?(me.audioWall.play(),Promise.resolve({isFailed:!0})):me.stick.isInStage(stage)?([me.playTip,me.foodTip].forEach(function(tip){tip&&(tip.hide(),tip=null)}),me.makeHeroWalkToNextEdge()):me.makeHeroWalkToStickEnd()})},level.makeHeroWalkToNextEdge=function(){var me=this,stage=this.stage,nextEdgeX=stage.getNextEdgeX(),foreground=this.foreground;return this.hero.walk(nextEdgeX).then(function(){return me.audioPass.play(),me.scoreboard.addScore(1),me.shouldMgScroll=!0,foreground.move(stage.getCurrEdgeX()-nextEdgeX).then(function(){me.shouldMgScroll=!1}),stage.addNext()}).then(function(result){return[me.stick,foreground].forEach(function(item){item.update()}),me.isHoldEnabled=!0,!global.getHasTool()&&result.hasFood&&(me.foodTip=new Tip(me.game,{text:config.TIP.FOOD})),Promise.resolve({isFailed:!1})})},level.makeHeroWalkToStickEnd=function(){var me=this;return this.hero.walk(this.stage.getCurrEdgeX()+this.stick.getLength()+12).then(function(){return me.isTouchEnabled=!1,Promise.resolve({isFailed:!0})})},level.fail=function(){var me=this,highest=global.getHighest(),score=this.scoreboard.getScore(),hasNewRecord=score>highest;hasNewRecord&&global.setHighest(score);var stick=this.stick,hero=this.hero;Promise.all([stick.fall(),hero.fall()]).then(function(){me.game.plugins.screenShake.shake(10),me.audioGround.play(),setTimeout(function(){hero.power.doubleLife?(hero.sustainLife(),stick.enablePlay(),hero.twinkle(),me.isHoldEnabled=!0):new End(me.game,{score:score,hasNewRecord:hasNewRecord})},400)})},level}),define("level/config",function(require){return{THEME:{1:{OFFSET:-30},2:{OFFSET:200},3:{OFFSET:100}},INITIAL_HORIZON:150,HORIZON:235,CURR_EDGE_X:110,FOOD_WIDTH:25,TIP:{PLAY:"按住屏幕\n使棒棒变长",FOOD:"行走时点击屏幕\n可翻转角色取道具"}}}),define("level/Stick",function(require){function Stick(game){this.game=game,this.image=null,this.trash=null,this.updateSpeed(),this.updateTexture(),this.updateExtraLength(),this.init()}var global=require("common/global"),Easing=require("common/Easing"),config=require("level/config");return Stick.prototype.init=function(){this.update()},Stick.prototype.update=function(){var game=this.game;this.image&&(this.trash&&this.trash.destroy(!1),this.trash=this.image);var image=game.add.tileSprite(config.CURR_EDGE_X,game.height-config.HORIZON,5,.001,this.texture);image.anchor.set(.5,1),this.image=image},Stick.prototype.enablePlay=function(){var image=this.image;image.height=0,image.angle=0},Stick.prototype.lengthen=function(){this.image.height<this.game.height-config.HORIZON&&(this.image.height+=this.speed)},Stick.prototype.rotate=function(angle,tweenOptions){var game=this.game,rotate=game.add.tween(this.image).to({angle:angle},tweenOptions.duration,Easing.Quadratic.In,!1,tweenOptions.delay),promise=new Promise(function(resolve){rotate.onComplete.add(resolve)});return rotate.start(),promise},Stick.prototype.layDown=function(){return this.rotate(90,{duration:400,delay:150})},Stick.prototype.fall=function(){return this.rotate(180,{duration:250,delay:100})},Stick.prototype.getPhaserObjects=function(){return[this.image,this.trash]},Stick.prototype.getLength=function(){return this.image.height},Stick.prototype.getFullLength=function(){return this.image.height+this.extraLength},Stick.prototype.isBetween=function(lower,upper){var length=this.getLength();return length>lower&&length<upper},Stick.prototype.isInStage=function(stage){return this.isBetween(stage.getInterval()-this.extraLength,stage.getNextEdgeX()-stage.getCurrEdgeX())},Stick.prototype.isInSpot=function(stage){var spotRange=stage.getSpotRange();return this.isBetween(spotRange.lower,spotRange.upper)},Stick.prototype.updateSpeed=function(){var speed=global.getHeroConfig().power.stickSpeed;this.speed=speed?speed:8},Stick.prototype.updateTexture=function(){var texture=global.getHeroConfig().power.stickTexture;this.texture=texture?texture:"stick"},Stick.prototype.updateExtraLength=function(){var extraLength=global.getHeroConfig().power.stickExtraLength;this.extraLength=extraLength?extraLength:0},Stick}),define("level/Stage",function(require){function Stage(game,options){this.game=game,this.index=options.index,this.imageName="stage-"+this.index,this.prev=null,this.curr=null,this.next=null,this.spot=null,this.oldFood=null,this.food=null,this.moveEasing=Easing.Linear.None,this.height=game.cache.getImage("stage-1").height,this.currEdgeX=config.CURR_EDGE_X,this.maxWidth=this.currEdgeX,this.updateMinWidth(),this.updateFoodProba(),this.updateSpotMultiple(),this.updateSpotWidth(),this.init()}var global=require("common/global"),util=require("common/util"),Easing=require("common/Easing"),config=require("level/config"),Food=require("./Food");return Stage.prototype.init=function(){var game=this.game;this.curr=game.add.tileSprite((game.width-this.maxWidth)/2,game.height-config.INITIAL_HORIZON-(this.height-config.HORIZON),this.maxWidth,this.height,"stage-3")},Stage.prototype.getRandomThemeImageName=function(){return"stage-"+this.game.rnd.between(1,3)},Stage.prototype.enablePlay=function(useTween){var game=this.game,nextWidth=this.maxWidth,next=game.add.tileSprite(game.width,game.height-this.height,nextWidth,this.height,this.getRandomThemeImageName());this.randomTilePosition(next),this.next=next,this.spot=this.createSpot(next);var curr=this.curr,currY=game.height-this.height,nextX=this.currEdgeX+game.rnd.between(40,180);if(useTween){var easing=this.moveEasing,moveCurr=game.add.tween(curr).to({x:0,y:currY},200,easing),moveNext=game.add.tween(next).to({x:nextX},200,easing),promise=new Promise(function(resolve){moveNext.onComplete.add(resolve)});return moveCurr.chain(moveNext),moveCurr.start(),promise}return curr.x=0,curr.y=currY,next.x=nextX,Promise.resolve()},Stage.prototype.randomTilePosition=function(pillar){pillar.tilePosition.x=-this.game.rnd.between(0,250-this.maxWidth)},Stage.prototype.createSpot=function(pillar){var spot=this.game.add.image(pillar.width/2,this.height-config.HORIZON,"spot");return spot.width=this.spotWidth,spot.anchor.set(.5,0),pillar.addChild(spot),spot},Stage.prototype.createFood=function(){var game=this.game;return new Food(game,{x:game.width,y:game.height-config.HORIZON+10})},Stage.prototype.addNext=function(){var game=this.game,nextWidth=game.rnd.between(this.minWidth,this.maxWidth),nextMargin=[20,10],nextX=game.rnd.between(this.currEdgeX+nextMargin[0],game.width-nextWidth-nextMargin[1]),food=this.createFood();food.hide();var foodWidth=food.getWidth(),foodX=nextX,hasFood=util.proba(this.foodProba)&&nextX-this.currEdgeX>=foodWidth+20;if(hasFood){foodX=game.rnd.between(this.currEdgeX+10,nextX-10-foodWidth),food.show();game.add.tween(food.getPhaserObject()).to({x:foodX},300,this.moveEasing).start()}var next=game.add.tileSprite(game.width+nextX-foodX,game.height-this.height,nextWidth,this.height,this.getRandomThemeImageName());this.randomTilePosition(next);var spot=this.createSpot(next),move=game.add.tween(next).to({x:nextX},300,this.moveEasing),me=this,promise=new Promise(function(resolve){move.onComplete.add(function(){this.prev&&this.prev.destroy(),this.prev=this.curr,this.curr=this.next,this.next=next,this.spot=spot,this.oldFood&&this.oldFood.destroy(),this.oldFood=this.food,this.food=food||null,resolve({hasFood:hasFood})},me)});return move.start(),promise},Stage.prototype.getCurrEdgeX=function(){return this.currEdgeX},Stage.prototype.getNextEdgeX=function(){var next=this.next;return next.x+next.width},Stage.prototype.getPhaserObjects=function(){var objects=[this.prev,this.curr,this.next];return[this.oldFood,this.food].forEach(function(item){item&&objects.push(item.getPhaserObject())}),objects},Stage.prototype.getInterval=function(){var curr=this.curr;return this.next.x-curr.x-curr.width},Stage.prototype.getSpotX=function(){return this.next.x+this.spot.x},Stage.prototype.getSpotRange=function(){var lower=this.getSpotX()-this.currEdgeX-this.spotWidth/2;return{lower:lower,upper:lower+this.spotWidth}},Stage.prototype.getFood=function(){return this.food},Stage.prototype.getSpotMultiple=function(){return this.spotMultiple},Stage.prototype.updateFoodProba=function(){var foodProba=global.getHeroConfig().power.foodProba;this.foodProba=foodProba?foodProba:.5},Stage.prototype.updateMinWidth=function(){var minWidth=global.getHeroConfig().power.stageMinWidth;this.minWidth=minWidth?minWidth:24},Stage.prototype.updateSpotMultiple=function(){var spotMultiple=global.getHeroConfig().power.spotMultiple;this.spotMultiple=spotMultiple?spotMultiple:1},Stage.prototype.updateSpotWidth=function(){var spotWidth=global.getHeroConfig().power.spotWidth;this.spotWidth=spotWidth?spotWidth:14},Stage}),define("level/Hero",function(require){function Hero(game,options){this.game=game,this.index=options.index,this.sprite=null,this.upsideDown=!1,this.init()}var global=require("common/global"),Easing=require("common/Easing"),config=require("level/config");return Hero.prototype.init=function(){this.initConfig(),this.initSprite()},Hero.prototype.initConfig=function(){var heroConfig=global.herosConfig[this.index];for(var key in heroConfig)heroConfig.hasOwnProperty(key)&&(this[key]=heroConfig[key])},Hero.prototype.initSprite=function(){var game=this.game,sprite=game.add.sprite((game.width+this.width*this.scale)/2,game.height-config.INITIAL_HORIZON);sprite.scale.set(this.scale),sprite.anchor.set(1,1),this.sprite=sprite,this.down()},Hero.prototype.enablePlay=function(useTween){var game=this.game,sprite=this.sprite,x=config.CURR_EDGE_X+this.paddingRight,y=game.height-config.HORIZON;if(useTween){var move=game.add.tween(sprite).to({x:x,y:y},200,Easing.Linear.None),me=this,promise=new Promise(function(resolve){move.onComplete.add(function(){this.down(),resolve()},me)});return this.act("walk",!0),move.start(),promise}return sprite.x=x,sprite.y=y,Promise.resolve()},Hero.prototype.act=function(action,loop){var sprite=this.sprite,key=[this.name,action].join("-");sprite.key!==key&&(sprite.loadTexture(key),!sprite.animations.getAnimation(action)&&sprite.animations.add(action),sprite.animations.play(action,this.actions[action].fps,!!loop))},Hero.prototype.down=function(){this.act("down",!0)},Hero.prototype.up=function(){this.act("walk",!0)},Hero.prototype.kick=function(){this.act("kick")},Hero.prototype.walk=function(targetX){var game=this.game,sprite=this.sprite;sprite.bringToTop();var maxX=game.width;(targetX+=this.paddingRight)>maxX&&(targetX=maxX);var duration=3*(targetX-sprite.x),move=game.add.tween(sprite).to({x:targetX},duration,Easing.Linear.None),me=this,promise=new Promise(function(resolve){move.onComplete.add(function(){this.down(),resolve()},me)});return this.act("walk",!0),move.start(),promise},Hero.prototype.getPhaserObjects=function(){return[this.sprite]},Hero.prototype.fall=function(){var game=this.game,fall=game.add.tween(this.sprite).to({y:game.height+(this.upsideDown?0:this.height)},300,Easing.Quadratic.In,!1,100),promise=new Promise(function(resolve){fall.onComplete.add(resolve)});return fall.start(),promise},Hero.prototype.flip=function(){this.sprite.scale.y*=-1,this.upsideDown=!this.upsideDown},Hero.prototype.isUpsideDown=function(){return this.upsideDown},Hero.prototype.getX=function(){return this.sprite.x},Hero.prototype.getWidth=function(){return this.sprite.width},Hero.prototype.change=function(index,isTemp){global.setSelected(index,!isTemp),this.index=index,this.initConfig();var game=this.game,sprite=this.sprite;sprite.x=(game.width+this.width*this.scale)/2,sprite.y=game.height-config.INITIAL_HORIZON,sprite.scale.set(this.scale),this.down();var level=game.state.states.level,stick=level.stick;stick&&(stick.updateSpeed(),stick.updateTexture(),stick.updateExtraLength());var stage=level.stage;stage.updateFoodProba(),stage.updateMinWidth(),stage.updateSpotMultiple(),stage.updateSpotWidth(),isTemp&&global.setSelected(this.power.previousLife,!1)},Hero.prototype.sustainLife=function(){this.change(this.power.nextLife,!0),this.enablePlay(!1)},Hero.prototype.twinkle=function(){var twinkle=this.game.add.tween(this.sprite).from({alpha:0},200,Easing.Linear.None,!0,0,1,!0),promise=new Promise(function(resolve){twinkle.onComplete.add(resolve)});return twinkle.start(),promise},Hero}),define("level/Food",function(require){var global=require("common/global"),color=require("common/color"),Easing=require("common/Easing"),Food=function(game,options){this.game=game,this.image=null,this.isEaten=!1,this.shaking=null,this.x=options.x,this.y=options.y,this.init()};return Food.prototype.init=function(){var game=this.game,heroConfig=global.getHeroConfig(),imageName=["tool",heroConfig.name,game.rnd.between(1,3)].join("-");this.image=game.add.image(this.x,this.y,imageName),this.image.scale.set(.45),this.shake()},Food.prototype.shake=function(){this.shaking=this.game.add.tween(this.image).to({y:"8"},1e3,Easing.Sinusoidal.InOut,!0,0,-1,!0)},Food.prototype.stopShaking=function(){this.shaking.stop()},Food.prototype.destroy=function(){this.image.destroy()},Food.prototype.getPhaserObject=function(){return this.image},Food.prototype.isStartingBeingEaten=function(hero){if(this.isEaten||!hero.isUpsideDown())return!1;var image=this.image,foodLeft=image.x,foodRight=image.x+image.width,heroRight=hero.getX(),heroLeft=heroRight-hero.getWidth();return foodLeft<heroRight&&foodRight>heroLeft&&(this.beEaten(),!0)},Food.prototype.beEaten=function(){this.isEaten=!0,this.stopShaking();var image=this.image;image.anchor.set(.5),image.x+=image.width/2,image.y+=image.height/2;var game=this.game,vanish=game.add.tween(image.scale).to({x:0,y:0},100,Easing.Quadratic.In);vanish.onComplete.add(function(){this.destroy()},this),vanish.start();var pointsText=game.add.text(image.x,image.y+20,"+2",{font:"bold 24px "+global.fontFamily,fill:color.get("white")});pointsText.anchor.set(.5,1),pointsText.alpha=0;var showPoints=game.add.tween(pointsText).to({alpha:.8},350,Easing.Quadratic.Out,!1),hidePoints=game.add.tween(pointsText).to({alpha:0},350,Easing.Quadratic.In,!1),risePoints=game.add.tween(pointsText).to({y:"+20"},700,Easing.Linear.None,!1);risePoints.onComplete.add(function(){pointsText.destroy()}),showPoints.chain(hidePoints),showPoints.start(),risePoints.start(),!global.getHasTool()&&global.setHasTool(1)},Food.prototype.getWidth=function(){return this.image.width},Food.prototype.hide=function(){this.image.alpha=0},Food.prototype.show=function(){this.image.alpha=1},Food}),define("common/weixin",function(require){function init(){var signPackage=global.getSignPackage();signPackage.jsApiList=["onMenuShareTimeline","onMenuShareAppMessage"],wx.config(signPackage),wx.ready(function(){updateShare()})}function updateShare(){var link="http://farm.yiluwan.org/efe-game/index.php",imgUrl="http://farm.yiluwan.org/efe-game/asset/img/icon-200.png";wx.onMenuShareTimeline({title:global.getShareText(),link:link,imgUrl:imgUrl,success:function(){global.setShared(1)}}),wx.onMenuShareAppMessage({title:"SSGer向前冲",desc:global.getShareText(),link:link,imgUrl:imgUrl})}var global=require("common/global");return{init:init,updateShare:updateShare}}),define("common/util",function(require){var util={};return util.isArray=function(item){return"Array"===Object.prototype.toString.call(item).slice(8,-1)},util.proba=function(p){p=10*p||1;var odds=Math.floor(10*Math.random());return 1===p||odds<p},util.inherits=function(type,superType){var Empty=function(){};Empty.prototype=superType.prototype;var proto=new Empty,originalPrototype=type.prototype;type.prototype=proto;for(var key in originalPrototype)proto[key]=originalPrototype[key];return type.prototype.constructor=type,type},util.addHover=function(btn,target){var events=btn.events;target=target?target:btn;var originAlpha=target.alpha;events.onInputDown.add(function(){target.alpha=.8*originAlpha}),events.onInputUp.add(function(){target.alpha=originAlpha})},util.firstToUpperCase=function(str){return str.substr(0,1).toUpperCase()+str.substr(1)},util}),define("common/url",function(){var workSpace="http://farm.yiluwan.org/efe-game/";return{GET_SIGNATURE:"http://www.yiluwan.org/ecomui/xiaoyouxi?controller=ajax&action=gettoken",USE_FOOD:workSpace+"food.php?type=minus",ADD_FOOD:workSpace+"food.php?type=plus",LOAD_DATA:workSpace+"storage.php",SAVE_DATA:workSpace+"storage.php",GET_RANK:workSpace+"rank.php"}}),define("common/serverData",function(){function load(keys,success,failure){ajax.get({url:url.LOAD_DATA,data:{key:keys.join(",")},success:success,failure:failure})}function save(data,success,failure){ajax.post({url:url.SAVE_DATA,data:data,success:success,failure:failure})}var ajax=require("common/ajax"),url=require("common/url");return{load:load,save:save}}),define("common/global",function(require){function handleMode(){var mode="dev";global.setMode=function(newMode){mode=newMode},global.getMode=function(){return mode},global.isDevMode=function(){return"dev"===mode},global.isProdMode=function(){return"prod"===mode}}function handleConst(){global.LEVEL_STATUS={MENU:0,PLAY:1},global.fontFamily='"Helvetica Neue", Helvetica, STHeiTi, sans-serif'}function handleStorage(){global.getStorage=function(keys){var storage={};return keys.forEach(function(key){storage[key]=localStorage.getItem(storageKey[key])}),storage},global.assignStorage=function(keys){keys.forEach(function(key){global["assign"+util.firstToUpperCase(key)]()})},global.initStorage=function(keys){keys.forEach(function(key){global["init"+util.firstToUpperCase(key)]()})},global.setStorage=function(obj){for(var key in obj)obj.hasOwnProperty(key)&&global["set"+util.firstToUpperCase(key)](obj[key],!1)},global.clearStorage=function(){for(var key in storageKey)storageKey.hasOwnProperty(key)&&localStorage.removeItem(storageKey[key])}}function handleFoodCount(){var foodCount;global.initFoodCount=function(count){foodCount=+localStorage.getItem(storageKey.foodCount),foodCount=foodCount?+foodCount:0},global.assignFoodCount=function(count){foodCount=count},global.getFoodCount=function(){return foodCount},global.setFoodCount=function(count,cb){function setLocal(){foodCount=count,localStorage.setItem(storageKey.foodCount,count)}if(count!==foodCount){var toBeAdded=count>foodCount;ajax.get({url:toBeAdded?url.ADD_FOOD:url.USE_FOOD,data:{count:Math.abs(count-foodCount)},success:function(res){res=JSON.parse(res),res.success&&(!toBeAdded&&setLocal(),cb&&cb()),res.success&&cb&&cb()}}),toBeAdded&&setLocal()}}}function handleHighest(){var highest;global.assignHighest=function(){highest=+localStorage.getItem(storageKey.highest)},global.initHighest=function(){global.setHighest(0)},global.getHighest=function(){return highest},global.setHighest=function(score,remote){highest=+score,void 0===remote&&(remote=!0),remote&&serverData.save({highest:highest}),localStorage.setItem(storageKey.highest,highest)}}function handleSelected(){var selected;global.assignSelected=function(){selected=+localStorage.getItem(storageKey.selected)},global.initSelected=function(){global.setSelected(0)},global.getSelected=function(){return selected},global.setSelected=function(index,remote){selected=+index,void 0===remote&&(remote=!0),remote&&serverData.save({selected:selected}),localStorage.setItem(storageKey.selected,selected)}}function handleShared(){var shared;global.assignShared=function(){shared=+localStorage.getItem(storageKey.shared)},global.initShared=function(){global.setShared(0)},global.getShared=function(){return shared},global.setShared=function(newShared,remote){shared=+newShared,void 0===remote&&(remote=!0),remote&&serverData.save({shared:shared}),localStorage.setItem(storageKey.shared,shared)}}function handleHasTool(){var hasTool;global.assignHasTool=function(){hasTool=+localStorage.getItem(storageKey.hasTool)},global.initHasTool=function(){global.setHasTool(0)},global.getHasTool=function(){return hasTool},global.setHasTool=function(newValue,remote){hasTool=+newValue,void 0===remote&&(remote=!0),remote&&serverData.save({hasTool:hasTool}),localStorage.setItem(storageKey.hasTool,hasTool)}}function handleUnlocks(){function setUnlock(index,value){unlocks[index]=value,saveUnlocks()}function saveUnlocks(remote){var unlocksStr=JSON.stringify(unlocks);void 0===remote&&(remote=!0),remote&&serverData.save({unlocks:unlocksStr}),localStorage.setItem(storageKey.unlocks,unlocksStr)}var unlocks;global.assignUnlocks=function(){unlocks=JSON.parse(localStorage.getItem(storageKey.unlocks))},global.initUnlocks=function(){unlocks=[1];for(var i=1,len=global.herosConfig.length;i<len;++i)unlocks.push(0);saveUnlocks(unlocks)},global.getUnlock=function(index){return unlocks[index]},global.setUnlocks=function(newUnlocks,remote){unlocks=util.isArray(newUnlocks)?unlocks:JSON.parse(newUnlocks),saveUnlocks(remote)},global.unlock=function(index){setUnlock(index,1)},global.lock=function(index){setUnlock(index,0)}}function handleNickname(){var nickname;global.assignNickname=function(){nickname=localStorage.getItem(storageKey.nickname)},global.initNickname=function(){global.setNickname("",!1)},global.getNickname=function(){return nickname},global.setNickname=function(name,remote){nickname=name,void 0===remote&&(remote=!0),remote&&serverData.save({nickname:nickname}),localStorage.setItem(storageKey.nickname,nickname)}}function handleSignPackage(){var signPackage;global.getSignPackage=function(){return signPackage},global.setSignPackage=function(obj){signPackage=obj}}function handleShareText(){var shareText;global.resetShareText=function(){shareText="【SSG程序员节】进攻时刻，SSGer向前冲！"},global.getShareText=function(){return shareText},global.setShareText=function(text){shareText=text}}function handleTryTimes(){var tryTimes=0;global.resetTryTimes=function(){tryTimes=0},global.getTryTimes=function(){return tryTimes},global.addTryTimes=function(){++tryTimes}}function handleNonShareTimes(){var times=0;global.resetNonShareTimes=function(){times=0},global.getNonShareTimes=function(){return times},global.addNonShareTimes=function(){++times}}function handleHerosConfig(){global.herosConfig=[{id:0,name:"rd",chName:"开发",color:"green",width:207,height:305,paddingRight:8,scale:.3,actions:{down:{fps:6},walk:{fps:6}},unlockType:"free",cost:0,desc:"",powerText:"",power:{}},{id:1,name:"ue",chName:"设计",color:"yellow",width:209,height:305,paddingRight:8,scale:.3,actions:{down:{fps:6},walk:{fps:6}},unlockType:"free",cost:0,desc:"",powerText:"",power:{}},{id:2,name:"sale",chName:"销售",color:"yellow",width:335,height:325,paddingRight:8,scale:.3,actions:{down:{fps:6},walk:{fps:6}},unlockType:"free",cost:0,desc:"",powerText:"",power:{}},{id:3,name:"service",chName:"职能",color:"green",width:207,height:305,paddingRight:8,scale:.3,actions:{down:{fps:6},walk:{fps:6}},unlockType:"free",cost:0,desc:"",powerText:"",power:{}},{id:4,name:"pm",chName:"产品",color:"green",width:207,height:305,paddingRight:8,scale:.3,actions:{down:{fps:6},walk:{fps:6}},unlockType:"free",cost:0,desc:"",powerText:"",power:{}},{id:5,name:"op",chName:"运营",color:"yellow",width:241,height:306,paddingRight:16,scale:.3,actions:{down:{fps:6},walk:{fps:6}},unlockType:"free",cost:0,desc:"",powerText:"",power:{}}],global.getHeroConfig=function(){return global.herosConfig[global.getSelected()]}}function handleNameTitle(){var nameTitles=["王牌","史诗","屠龙","超级","金牌","流浪","全能","神圣","天才","鬼才","极品","狼性","顶尖","强力","壮志","无双","天生","风云","倚天","盖世","绝世","有爱","妙手","雄才","鬼斧","智勇","先知","百战","鲜肉","美艳","传说","大侠","精英","魔王","狂魔","逆天","暴走","神级","天王","魔性","走心","神速","实力","驰名","元老","觉醒","王者","土豪","白金","黄金","激萌","宗师","超神","强者","无敌","炸天","核心"],len=nameTitles.length;global.getRandomNameTitle=function(){return nameTitles[Math.floor(Math.random()*len)]}}var ajax=require("common/ajax"),url=require("common/url"),util=require("common/util"),serverData=require("common/serverData"),storageKey={foodCount:"attackingtime-food-count",highest:"attackingtime-highest",selected:"attackingtime-selected",unlocks:"attackingtime-unlocks",shared:"attackingtime-shared",nickname:"attackingtime-nickname",hasTool:"attackingtime-has-tool"},global={};return global.setResource=function(){global.isProdMode()?(global.path="http://ishowshao-game.qiniudn.com/efe-game/asset/img/",global.suffix=".png?v=1489394876",global.audioPath="asset/audio/"):(global.path="http://ishowshao-game.qiniudn.com/efe-game/asset/img/",global.suffix=".png",global.audioPath="asset/audio/")},function(){handleConst(),handleMode(),handleHerosConfig(),handleNameTitle(),handleStorage(),handleFoodCount(),handleHighest(),handleSelected(),handleUnlocks(),handleShared(),handleHasTool(),handleNickname(),handleSignPackage(),handleShareText(),handleTryTimes(),handleNonShareTimes()}(),global}),define("common/color",function(require){function get(color){return colors[color]}var colors={bg:"#91d1d2",white:"#fff",black:"#000","dark-grey":"#555","darker-grey":"#333",chocolate:"#a45d35",beige:"#ffecb8","dark-beige":"#e1d0a1",coffee:"#554d36",yellow:"#ffcd43",cherry:"#e46462",orange:"#ffad5d","dark-purple":"#826865",red:"#d6393a"};return{get:get}}),define("common/ajax",function(require){function toQuery(data){var query=[];for(var key in data)data.hasOwnProperty(key)&&query.push(encodeURIComponent(key)+"="+encodeURIComponent(data[key]));return query.join("&")}function post(settings){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){4===xhr.readyState&&(200===xhr.status?settings.success&&settings.success(xhr.responseText,xhr):settings.failure&&settings.failure(xhr.status,xhr))},xhr.open("POST",settings.url?settings.url:""),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(this.toQuery(settings.data?settings.data:{}))}function get(settings){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){4===xhr.readyState&&(200===xhr.status?settings.success&&settings.success(xhr.responseText,xhr):settings.failure&&settings.failure(xhr.status,xhr))};var data=settings.data||{},url=settings.url||"";url+=url.indexOf("?")===-1?"?"+this.toQuery(data):"&"+this.toQuery(data),xhr.open("GET",url),xhr.send()}return{toQuery:toQuery,post:post,get:get}}),define("common/Easing",function(){return Phaser.Easing}),define("preload",function(require){function init(options){loadingImage=options.loadingImage}function preload(){var game=this.game;initLoading(game),loadResources(game)}function initLoading(game){game.add.text(game.width/2,260,"SSGer准备中...",{font:"bold 30px "+global.fontFamily,fill:color.get("white")}).anchor.set(.5);var hero=game.add.sprite(game.width/2,game.height/2,loadingImage);hero.anchor.set(.5),hero.scale.set(.5);hero.animations.add("down"),hero.animations.play("down",6,!0)}function loadResources(game){var path=global.path,suffix=global.suffix;["bgm","ground","click","stick-lay-down","pass","tool","spot","stick-lengthen","wall","hero-fly","fly"].forEach(function(name){game.load.audio(name,[global.audioPath+name+".ogg",global.audioPath+name+".mp3"])}),["transparent","transparent-2","spot","title-xqc","title-xd","title-fly","title-hero","start","start-ring","menu-btn","icon-hero","icon-podium","scoreboard","popup-edge","popup-header","panel-edge-yellow","panel-edge-green","me-tip","end-board","new-record","end-doll","copyright","building","dialog-rank","dialog-rank-doll","btn-share","btn-home","btn-restart"].forEach(function(name){game.load.image(name,path+name+suffix)}),["black","white","yellow","green"].forEach(function(color){game.load.image("pixel-"+color,path+"pixel/"+color+suffix)}),["stick"].forEach(function(name){game.load.spritesheet(name,path+name+suffix,5,24)}),global.herosConfig.forEach(function(hero){var name=hero.name,actions=hero.actions;for(var action in actions)actions.hasOwnProperty(action)&&game.load.spritesheet([name,action].join("-"),path+name+"/"+action+suffix,hero.width,hero.height);game.load.image("legend-"+name,path+"legend/"+name+suffix);for(var i=1;i<=3;++i){var fileName=[name,i].join("-");game.load.image(["tool",fileName].join("-"),path+"tool/"+fileName+suffix)}}),[1580].forEach(function(width,index){var no=index+1,dir=path+"view-"+no+"/";["bg","mg-far","mg-near"].forEach(function(name){game.load.spritesheet(name,dir+name+suffix,width,800)})}),[243,243,243].forEach(function(height,index){var name="stage-"+(index+1);game.load.spritesheet(name,path+name+suffix,168,height)})}function create(){var me=this;fetchData().then(function(){me.state.start("level",!0,!1,global.LEVEL_STATUS.MENU)});var game=this.game,bgm=game.add.audio("bgm");game.sound.setDecodedCallback([bgm],function(){bgm.loopFull()},this)}function fetchData(){var keys=["highest","selected","unlocks","shared","hasTool"],storage=global.getStorage(keys),serverKeys=["nickname"];for(var key in storage)storage.hasOwnProperty(key)&&null===storage[key]&&serverKeys.push(key);var localKeys=[];return keys.forEach(function(key){serverKeys.indexOf(key)===-1&&localKeys.push(key)}),localKeys.length&&global.assignStorage(localKeys),global.initStorage(serverKeys),Promise.resolve()}var loadingImage,global=require("common/global"),color=require("common/color");return{init:init,preload:preload,create:create}}),define("main",function(require){function init(){global.isProdMode()&&require("common/weixin").init(),initGame()}function initGame(){var game=new Phaser.Game(480,800,Phaser.CANVAS,"");game.state.add("boot",require("boot")),game.state.add("preload",require("preload")),game.state.add("level",require("level/level")),game.state.start("boot")}var global=require("common/global");return{init:init}}),define("boot",function(require){function preload(){global.setResource();var game=this.game,herosConfig=global.herosConfig,loadingHeroIndex=game.rnd.between(0,herosConfig.length-1),heroConfig=herosConfig[loadingHeroIndex],heroName=heroConfig.name;loadingImage=heroName+"-down",game.load.spritesheet(loadingImage,global.path+heroName+"/down"+global.suffix,heroConfig.width,heroConfig.height),game.load.audio("bgm",[global.audioPath+"bgm.ogg",global.audioPath+"bgm.mp3"])}function create(){var game=this.game;game.stage.backgroundColor=require("common/color").get("bg"),game.plugins.screenShake=game.plugins.add(Phaser.Plugin.ScreenShake),game.plugins.screenShake.setup({shakeX:!1,shakeY:!0,
sensCoef:.3});var scale=this.scale;scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,scale.pageAlignHorizontally=!0,scale.pageAlignVertically=!0,setTimeout(function(){game.state.start("preload",!0,!1,{loadingImage:loadingImage})},100)}var loadingImage,global=require("common/global");return{preload:preload,create:create}});